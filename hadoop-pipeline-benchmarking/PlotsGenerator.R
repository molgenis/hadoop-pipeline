########
# Name:
# PlotsGenerator
#
# Description:
# Plots job information to SVG files for benchmarking analysis of Hadoop jobs.
# Uses csv files as generated by job information retrieving/processing python scripts.
########






##################
### Functions  ###
##################

########
# Name:
# millisecondsToMinutes
#
# Description:
# Converts an integer representing a value in milliseconds to a value representing minutes.
#
# Input:
# milliseconds - A vector containing integers.
#
# Output:
# integer
########
millisecondsToMinutes <- function(milliseconds) {
  return(milliseconds / 1000 / 60)
}

########
# Name:
# millisecondsToHours
#
# Description:
# Converts an integer representing a value in milliseconds to a value representing hours.
#
# Input:
# milliseconds - A vector containing integers.
#
# Output:
# integer
########
millisecondsToHours <- function(milliseconds) {
  return(millisecondsToMinutes(milliseconds) / 60)
}

########
# Name:
# millisecondsToDays
#
# Description:
# Converts an integer representing a value in milliseconds to a value representing days.
#
# Input:
# milliseconds - A vector containing integers.
#
# Output:
# integer
########
millisecondsToDays <- function(milliseconds) {
  return(millisecondsToHours(milliseconds) / 24)
}

########
# Name:
# retrieveOrderedJobIdsBasedOnGroups
#
# Description:
# Retrieves the order of JobIds based on their order in the groups list.
# Also allows to filter out job IDs by using a groups list that does not include
# the regions which should be filtered out.
#
# Input:
# jobIds - A vector with Strings representing the job IDs.
# groups - A list containing vectors defining which job ID belongs to which group.
#
# Output:
# The order of the job IDs based on where they are in the groups list.
########
retrieveOrderedJobIdsBasedOnGroups <- function(jobIds, groups) {
  return(unlist(sapply(unlist(groups), jobIds=jobIds, function(group, jobIds) {which(jobIds == group)})))
}

########
# Name:
# generateColors
#
# Description:
# Generates a vector with color codes. For each JobId, investigates in which group it is
# present and depending on the group assigns a specific color from the colorList. Note
# that the groups should have the same length as the colorList and each JobId should only
# be present once in groups (and preferably also in JobIds).
#
# Input:
# jobIds - A vector with Strings representing the job IDs.
# groups - A list containing vectors defining which job ID belongs to which group.
# colorList - A vector with color codes, 1 color for each group in groups.
#
# Output:
# A vector with color codes, 1 color per job ID.
########
generateColors <- function(jobIds, groups, colorList) {
  colors <- unlist(sapply(jobIds, groups=groups, colorList=colorList, function(jobId, groups, colorList) {
    colorList[which(sapply(groups, jobId=jobId, function(group, jobId) {jobId %in% group}) == TRUE)]
  }))
  names(colors) <- jobIds
  return(colors)
}

########
# Name:
# plotJobBars
#
# Description:
# Creates a barplot based on the input parameters.
#
# Input:
# data - A vector containing integers (values to plot).
# colors - A vector containing RGB color codes (to color the values).
# main - A String containing the plot title.
# ylab - A String containing the y-axis label.
# ymax - A number representing the y-axis max limit.
########
plotJobBars <- function(data, colors, main, ylab, ymax) {
  barplot(data, col=colors, main=main, axisnames=FALSE,
          ylab=ylab, las=1, ylim=c(0,ymax))
}

########
# Name:
# plotTasks
#
# Description:
# Creates a lineplot based on the input parameters.
#
# Input:
# JobIdColumnData - A list containing the Job IDs (column from table).
# columnDataToPlot - A list containing the values to plot (column from table).
#                    Items should be ordered so that each position in columnDataToPlot
#                    have on the same position in JobIdColumnData their job ID represented.
#                    Expected usage should therefore be that both represent their column
#                    from the same table.
# groupsToPlot - The groups from which the values should be plotted.
# colors - The colors for all job Ids in groupsToPlot.
# main - A String containing the plot title.
# xlab - A String containing the x-axis label.
# ylab - A String containing the y-axis label.
# xmax - A number representing the x-axis max limit.
# ymin - A number representing the y-axis min limit.
# ymax - A number representing the y-axis max limit.
########
plotTasks <- function(JobIdColumnData, columnDataToPlot, groupsToPlot, colors, main, xlab, ylab, xmax, ymin, ymax) {
  # Filters out groups that have NULL values.
  groupsToPlot <- groupsToPlot[groupsToPlot != 'NULL']
  
  # Plots window with axes and names but no lines yet.
  # xlim lowest 2 moves start of lines more to the left (x-axis value 5 still means the fifth reduces is at that position)
  plot(columnDataToPlot[JobIdColumnData == unlist(groupsToPlot[1])], type='n', las=1,
       ylim=c(ymin, ymax), xlim=c(2,xmax), main=main, ylab=ylab, xlab=xlab)
  
  # Stores the global position of a single job as if groupsToPlot was unlisted.
  globalPos = 0
  
  # Goes through each group.
  for(group in groupsToPlot) {
    
    # Goes through each job from a single group.
    for(index in 1:length(group)) {
      # Updates the global position.
      globalPos <- globalPos + 1
      
      # Defines the line type of the job.
      if(index == 1) {plotLty = 1}
      else if(index == 2) {plotLty = 5}
      else {plotLty = 3}
      
      # Plots the line.
      lines(columnDataToPlot[JobIdColumnData == unlist(groupsToPlot)[globalPos]],
            col=colors[globalPos], lty=plotLty, lwd=1.5)
    }
  }
}






##################
### Parameters ###
##################

# Input files. Replace paths to actual file paths.
jobsCsv <- '~/programming/projects/hadoop-pipeline/benchmark_results/jobs.csv'
mapTasksCsv <- '~/programming/projects/hadoop-pipeline/benchmark_results/tasks_map.csv'
reduceTasksCsv <- '~/programming/projects/hadoop-pipeline/benchmark_results/tasks_reduce.csv'

# Stores output directory for plots. Replace paths to desired output folder.
outputDir <- '~/Documents/stage/images/'

# Defines the job groups. Replace example job IDs with ones present in the input files.
# When adjusting the groups, be sure to validate other parts of the script as well.
groups <- list(
  '62mb input splits, full chromosome bed & 86 reducers'=c('job_1458320004153_27523', 'job_1458320004153_27551'),
  '124mb input splits, full chromosome bed & 6 reducers'=c('job_1458320004153_20425', 'job_1458320004153_22671', 'job_1458320004153_24743'),
  '124mb input splits, full chromosome bed & 12 reducers'=c('job_1458320004153_18172', 'job_1458320004153_18380'),
  '124mb input splits, full chromosome bed & 24 reducers'=c('job_1458320004153_15117', 'job_1458320004153_15124'),
  '124mb input splits, full chromosome bed & 86 reducers'=c('job_1458320004153_15136', 'job_1458320004153_15169'),
  '124mb input splits, centromere split bed & 24 reducers'=c('job_1458320004153_24838', 'job_1458320004153_25596'),
  '124mb input splits, centromere split bed & 48 reducers'=c('job_1458320004153_17877', 'job_1458320004153_20286'),
  '124mb input splits, centromere split bed & 110 reducers'=c('job_1458320004153_26445', 'job_1458320004153_26806'),
  '124mb input splits, 5 GPM WGS bed & 935 reducers'=c('job_1458320004153_23679', 'job_1458320004153_23775'),
  '124mb input splits, 5 GPM WGS bed & 1870 reducers'=c('job_1458320004153_16545', 'job_1458320004153_16767'))

groups.124mb <- groups[2:10]
groups.124mb.no5Gpm <- groups[2:8]
groups.124mb.only5Gpm <- groups[9:10]
groups.inputSplitComparison <- groups[c(1,5)]






##################
###    Code    ###
##################

######## General ########
# Defines default par view.
oldpar <- par()

# Generates better legend names.
legendNames.124mb <- sapply(names(groups.124mb), function(x) {strsplit(x, ', ')[[1]][2]})
legenNames.mbInputSplits<- sapply(names(groups.inputSplitComparison), function(x) {strsplit(x, ', ')[[1]][1]})

# Generates group plot colors.
colorList.124mb <- colorRampPalette(c('blue4', 'lightsteelblue1', 'aquamarine4', 'yellow2', 'darkorange2')) (n=length(groups.124mb))
names(colorList.124mb) <- names(groups.124mb)

colorList.inputSplitComparison <- c('firebrick4', 'darkslategray4')
names(colorList.inputSplitComparison) <- names(groups.inputSplitComparison)

# Reads in files
jobs <- as.matrix(read.table(jobsCsv, row.names=1, header=TRUE, sep=','))
mapTasks <- read.table(mapTasksCsv, header=TRUE, sep=',')
reduceTasks <- read.table(reduceTasksCsv, header=TRUE, sep=',')






######## Job 124mb statistics ########
# Generates plot data for groups with 124mb splits
jobs.124mb <- jobs[retrieveOrderedJobIdsBasedOnGroups(rownames(jobs), groups.124mb),]

# Links each job id to a color specific for their group.
colors.124mb <- generateColors(rownames(jobs.124mb), groups=groups.124mb, colorList=colorList.124mb)

# Generate job plots and write to svg file.
svg(paste0(outputDir, 'Rplot_jobs_reduceparams.svg'), height=9, width=7)
par(mfrow=c(4,3), xpd=NA)
plotJobBars(millisecondsToHours(jobs.124mb[,'ELAPSED_TIME']), colors.124mb, 'total elapsed time', 'time in hours', 8)
plotJobBars(millisecondsToDays(jobs.124mb[,'CPU_MILLISECONDS_TOTAL']), colors.124mb, 'total CPU time', 'time in days', 14)
plotJobBars(millisecondsToDays(jobs.124mb[,'CPU_MILLISECONDS_MAP']), colors.124mb, 'map CPU time', 'time in days', 14)
plotJobBars(millisecondsToHours(jobs.124mb[,'CPU_MILLISECONDS_REDUCE']), colors.124mb, 'reduce CPU time', 'time in hours', 20)
plotJobBars(millisecondsToMinutes(jobs.124mb[,'AVERAGE_MAP_TIME']), colors.124mb, 'average map time', 'time in minutes', 20)
plotJobBars(millisecondsToMinutes(jobs.124mb[,'AVERAGE_REDUCE_TIME']), colors.124mb, 'average reduce time', 'time in minutes', 120)
plotJobBars(millisecondsToMinutes(jobs.124mb[,'AVERAGE_MERGE_TIME']), colors.124mb, 'average merge time', 'time in minutes', 8)
plotJobBars(millisecondsToMinutes(jobs.124mb[,'AVERAGE_SHUFFLE_TIME']), colors.124mb, 'average shuffle time', 'time in minutes', 140)
plotJobBars(jobs.124mb[,'DATA_LOCAL_MAPS'], colors.124mb, 'data local maps', 'map tasks (n)', 1200)
plotJobBars(jobs.124mb[,'RACK_LOCAL_MAPS'], colors.124mb, 'rack local maps', 'map tasks (n)', 110)
plotJobBars(jobs.124mb[,'OTHER_LOCAL_MAPS'], colors.124mb, 'other local maps', 'map tasks (n)', 40)
legend(28,50, legendNames.124mb, fill=colorList.124mb)
dev.off()

rm(jobs.124mb, colors.124mb)






######## Job map input splits statistics ########
# Generates plot data for groups with 124mb splits
jobs.inputSplitComparison <- jobs[retrieveOrderedJobIdsBasedOnGroups(rownames(jobs), groups.inputSplitComparison),]

# Links each job id to a color specific for their group.
colors.inputSplitComparison <- generateColors(rownames(jobs.inputSplitComparison), groups=groups.inputSplitComparison,
                               colorList=colorList.inputSplitComparison)

# Generate job plots and write to svg file.
svg(paste0(outputDir, 'Rplot_jobs_inputcomparison.svg'), height=9, width=7)
par(mfrow=c(4,3), xpd=NA)
plotJobBars(millisecondsToHours(jobs.inputSplitComparison[,'ELAPSED_TIME']), colors.inputSplitComparison, 'total elapsed time', 'time in hours', 3)
plotJobBars(millisecondsToDays(jobs.inputSplitComparison[,'CPU_MILLISECONDS_TOTAL']), colors.inputSplitComparison, 'total CPU time', 'time in days', 14)
plotJobBars(millisecondsToDays(jobs.inputSplitComparison[,'CPU_MILLISECONDS_MAP']), colors.inputSplitComparison, 'map CPU time', 'time in days', 12)
plotJobBars(millisecondsToHours(jobs.inputSplitComparison[,'CPU_MILLISECONDS_REDUCE']), colors.inputSplitComparison, 'reduce CPU time', 'time in hours', 20)
plotJobBars(millisecondsToMinutes(jobs.inputSplitComparison[,'AVERAGE_MAP_TIME']), colors.inputSplitComparison, 'average map time', 'time in minutes', 16)
plotJobBars(millisecondsToMinutes(jobs.inputSplitComparison[,'AVERAGE_REDUCE_TIME']), colors.inputSplitComparison, 'average reduce time', 'time in minutes', 8)
plotJobBars(millisecondsToMinutes(jobs.inputSplitComparison[,'AVERAGE_MERGE_TIME']), colors.inputSplitComparison, 'average merge time', 'time in minutes', 0.6)
plotJobBars(millisecondsToMinutes(jobs.inputSplitComparison[,'AVERAGE_SHUFFLE_TIME']), colors.inputSplitComparison, 'average shuffle time', 'time in minutes', 100)
plotJobBars(jobs.inputSplitComparison[,'DATA_LOCAL_MAPS'], colors.inputSplitComparison, 'data local maps', 'map tasks (n)', 2000)
plotJobBars(jobs.inputSplitComparison[,'RACK_LOCAL_MAPS'], colors.inputSplitComparison, 'rack local maps', 'map tasks (n)', 110)
plotJobBars(jobs.inputSplitComparison[,'OTHER_LOCAL_MAPS'], colors.inputSplitComparison, 'other local maps', 'map tasks (n)', 300)
legend(8,200, legenNames.mbInputSplits, fill=colorList.inputSplitComparison)
dev.off()

rm(jobs.inputSplitComparison, colors.inputSplitComparison)






######## map tasks input splits statistics ########
# Filter out tasks that did not succeed and removes state column.
succesfullMapTasks <- mapTasks[mapTasks[,'STATE'] == 'SUCCEEDED',1:ncol(mapTasks)-1]

# Order data first by CPU time.
succesfullMapTasks <- succesfullMapTasks[order(succesfullMapTasks[,'CPU_MILLISECONDS'], decreasing=TRUE),]

# Order maps and filter by job ID.
succesfullMapTasks.comparison <- succesfullMapTasks[retrieveOrderedJobIdsBasedOnGroups(succesfullMapTasks[,'JOB_ID'], groups.inputSplitComparison),]

# Create a color per job ID.
mapTasksColors.comparison <- generateColors(unique(succesfullMapTasks.comparison['JOB_ID'])[[1]], groups=groups.inputSplitComparison,
                                                 colorList=colorList.inputSplitComparison)

# Generate map task plots for jobs comparing 62mb split jobs with 124mb input split jobs.
svg(paste0(outputDir, 'Rplot_map_tasks_comparison.svg'), height=6, width=8)
par(mfrow=c(1,2), mar=c(11,4,4,2), xpd=FALSE)
plotTasks(succesfullMapTasks.comparison['JOB_ID'], millisecondsToMinutes(succesfullMapTasks.comparison['CPU_MILLISECONDS']),
          groups.inputSplitComparison, mapTasksColors.comparison, 'CPU time per mapper', 'mappers ordered by decreasing CPU time',
          'time in minutes', 2500, 0, 20)
rect(660,14,810,18, border='black', lty=2)
rect(1350,6,1650,10, border='black', lty=2)
plotTasks(succesfullMapTasks.comparison['JOB_ID'], succesfullMapTasks.comparison['MAP_OUTPUT_RECORDS'] / 1000000,
          groups.inputSplitComparison, mapTasksColors.comparison, 'output records per mapper', 'mappers ordered by decreasing CPU time',
          'n records (times 1 million)', 2500, 0, 2)
rect(660,1.4,810,1.8, border='black', lty=2)
rect(1350,0.6,1650,1, border='black', lty=2)
par(xpd=NA)
legend(-2100,-0.85, legenNames.mbInputSplits, fill=colorList.inputSplitComparison)
legend(0,-0.85, paste('run', 1:2), lty=c(1,5))
dev.off()

rm(succesfullMapTasks, succesfullMapTasks.comparison, mapTasksColors.comparison)






######## reduce tasks 124mb general processing (filter succesfull and order by CPU time) ########
# Filter out tasks that did not succeed and removes state column.
succesfullReduceTasks <- reduceTasks[reduceTasks[,'STATE'] == 'SUCCEEDED',1:ncol(reduceTasks)-1]

# Order data first by CPU time.
succesfullReduceTasks <- succesfullReduceTasks[order(succesfullReduceTasks[,'CPU_MILLISECONDS'], decreasing=TRUE),]





######## reduce tasks 124mb no5gpm jobs statistics ########
# Retrieves reduce tasks excluding 5GPM jobs (ordered by job ID).
succesfullReduceTasks.no5Gpm <- succesfullReduceTasks[retrieveOrderedJobIdsBasedOnGroups(succesfullReduceTasks[,'JOB_ID'],
                                                                                         groups.124mb.no5Gpm),]
reduceTasksColors.124mb.no5Gpm <- generateColors(unique(succesfullReduceTasks.no5Gpm['JOB_ID'])[[1]], groups=groups.124mb.no5Gpm,
                                                 colorList=colorList.124mb[names(groups.124mb.no5Gpm)])

# Generate reduce task plots for jobs without the 5GPM bed file and write to svg file.
svg(paste0(outputDir, 'Rplot_reduce_tasks_no5gpm.svg'), height=8, width=8)
par(mfrow=c(1,2), mar=c(11,4,4,2), xpd=FALSE)
plotTasks(succesfullReduceTasks.no5Gpm['JOB_ID'], millisecondsToHours(succesfullReduceTasks.no5Gpm['CPU_MILLISECONDS']),
          groups.124mb.no5Gpm, reduceTasksColors.124mb.no5Gpm, 'CPU time per reducer', 'reducers ordered by decreasing CPU time',
          'time in hours', 35, 0, 7)
plotTasks(succesfullReduceTasks.no5Gpm['JOB_ID'], succesfullReduceTasks.no5Gpm['REDUCE_INPUT_RECORDS'] / 1000000,
          groups.124mb.no5Gpm, reduceTasksColors.124mb.no5Gpm, 'input records per reducer', 'reducers ordered by decreasing CPU time',
          'n records (times 1 million)', 35, 0, 600)
par(xpd=NA)
legend(-58,-150, legendNames.124mb[names(groups.124mb.no5Gpm)], fill=colorList.124mb[names(groups.124mb.no5Gpm)], ncol=2)
legend(26,-150, paste('run', 1:3), lty=c(1,5,3))
dev.off()

rm(succesfullReduceTasks.no5Gpm, reduceTasksColors.124mb.no5Gpm)





######## reduce tasks 124mb no5gpm jobs statistics ########
# Retrieves reduce tasks only 5GPM jobs.
succesfullReduceTasks.only5Gpm <- succesfullReduceTasks[retrieveOrderedJobIdsBasedOnGroups(succesfullReduceTasks[,'JOB_ID'], groups.124mb.only5Gpm),]
reduceTasksColors.124mb.only5Gpm <- generateColors(unique(succesfullReduceTasks.only5Gpm['JOB_ID'])[[1]], groups=groups.124mb.only5Gpm,
                                                   colorList=colorList.124mb[names(groups.124mb.only5Gpm)])

# Generate reduce task plots for jobs only with the 5GPM bed file and write to svg file.
svg(paste0(outputDir, 'Rplot_reduce_tasks_only5gpm.svg'), height=6, width=8)
par(mfrow=c(1,2), mar=c(11,4,4,2), xpd=FALSE)
plotTasks(succesfullReduceTasks.only5Gpm['JOB_ID'], millisecondsToMinutes(succesfullReduceTasks.only5Gpm['CPU_MILLISECONDS']),
          groups.124mb.only5Gpm, reduceTasksColors.124mb.only5Gpm, 'CPU time per reducer', 'reducers ordered by decreasing CPU time',
          'time in minutes', 1880, 0, 8)
plotTasks(succesfullReduceTasks.only5Gpm['JOB_ID'], log10(succesfullReduceTasks.only5Gpm['REDUCE_INPUT_RECORDS']),
          groups.124mb.only5Gpm, reduceTasksColors.124mb.only5Gpm,'input records per reducer', 'reducers ordered by decreasing CPU time',
          'log10(n) records', 1880, 4.5, 7.5)
par(xpd=NA)
legend(-2500,3.2, legendNames.124mb[names(groups.124mb.only5Gpm)], fill=colorList.124mb[names(groups.124mb.only5Gpm)], ncol=1)
legend(0,3.2, paste('run', 1:3), lty=c(1,5,3))
dev.off()

rm(succesfullReduceTasks.only5Gpm, reduceTasksColors.124mb.only5Gpm)





######## reduce tasks 124mb general cleanup ########
rm(succesfullReduceTasks)


